{% load static %}
<!-- CONTENIDO SOLO PARA MODAL (sin layout completo) -->
<button class="cerrar text-white hover:text-[#C0A76B] text-4xl font-bold cursor-pointer absolute top-4 right-6 z-20 transition-all hover:scale-110" 
        onclick="cerrarProductoModal()" 
        title="Cerrar">
    &times;
</button>

<div class="w-full max-h-[90vh] overflow-y-auto p-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Columna Izquierda - Imagen -->
        <div class="relative">
            <div class="sticky top-0">
                <img id="modal-producto-imagen" 
                     src="{{ producto.imagen_url|default:'/static/imagenes/placeholder.png' }}" 
                     alt="{{ producto.nombre }}" 
                     class="w-full rounded-xl border-4 border-[#C0A76B] shadow-2xl hover:scale-105 transition-transform duration-300">
                
                <!-- Badge IA -->
                <div id="modal-ia-badge" class="hidden absolute top-4 left-4 bg-purple-900 bg-opacity-95 text-purple-200 px-4 py-2 rounded-lg border-2 border-purple-400 shadow-lg">
                    <i class="fas fa-robot mr-2"></i>
                    <span class="font-semibold">Generado con IA</span>
                </div>
            </div>
        </div>
        
        <!-- Columna Derecha - Informaci√≥n completa del producto -->
        <div class="text-white space-y-4">
            <!-- Nombre y Categor√≠a -->
            <div class="border-b border-[#C0A76B] pb-4">
                <h1 class="text-4xl font-bold text-[#C0A76B] mb-2">
                    {{ producto.nombre }}
                </h1>
                <p class="text-gray-400 text-sm flex items-center gap-2">
                    <i class="fas fa-tag"></i>
                    <span>{{ producto.get_categoria_display }}</span>
                </p>
            </div>
            
            <!-- Precio -->
            <div class="bg-gradient-to-r from-[#C0A76B]/10 to-yellow-900/10 border-2 border-[#C0A76B] rounded-xl p-4">
                <p class="text-sm text-gray-400 uppercase tracking-wide mb-1">Precio</p>
                <p class="text-3xl font-bold text-white">
                    ${{ producto.precio|floatformat:2 }}
                </p>
            </div>
            
            <!-- Descripci√≥n -->
            <div class="bg-[#1a1a1a] border border-[#C0A76B] border-opacity-30 rounded-xl p-4">
                <h3 class="text-lg font-semibold text-[#C0A76B] mb-2 flex items-center gap-2">
                    <i class="fas fa-align-left"></i>Descripci√≥n
                </h3>
                <p class="text-gray-300 text-sm leading-relaxed">
                    {{ producto.descripcion|default:"Sin descripci√≥n disponible" }}
                </p>
            </div>
            
            <!-- Informaci√≥n General -->
            <div class="bg-[#1a1a1a] border border-[#C0A76B] border-opacity-30 rounded-xl p-4">
                <h3 class="text-lg font-semibold text-[#C0A76B] mb-3 flex items-center gap-2">
                    <i class="fas fa-info-circle"></i>Informaci√≥n General
                </h3>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div>
                        <p class="text-gray-400 text-xs uppercase">Categor√≠a</p>
                        <p class="text-white font-semibold">{{ producto.get_categoria_display }}</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-xs uppercase">Stock Base</p>
                        <p class="text-white font-semibold">{{ producto.stock|default:0 }} unidades</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-xs uppercase">Destacado</p>
                        <p class="text-white font-semibold">{% if producto.destacado %}S√≠{% else %}No{% endif %}</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-xs uppercase">ID</p>
                        <p class="text-white font-semibold">#{{ producto.id }}</p>
                    </div>
                </div>
            </div>
            
            {% if variantes %}
            <!-- Colores Disponibles (PRIMERO, con botones circulares de colores) -->
            <div class="space-y-4">
                <h3 class="text-xl font-bold text-[#C0A76B] mb-4 flex items-center gap-2 border-b-2 border-[#C0A76B] pb-2">
                    <i class="fas fa-palette text-2xl"></i>Colores Disponibles
                </h3>
                <div class="flex flex-wrap gap-4" id="modal-colores-container">
                    {% for color in colores_disponibles|slice:":3" %}
                    <button class="modal-color-btn relative group" data-color="{{ color }}" onclick="seleccionarColor('{{ color }}')">
                        <div class="w-16 h-16 rounded-full border-4 border-transparent transition-all duration-300 hover:scale-110 hover:border-[#C0A76B] shadow-lg" 
                             style="background-color: {% if color == 'Negro' %}#000000{% elif color == 'Blanco' %}#FFFFFF{% elif color == 'Rojo' %}#DC2626{% elif color == 'Azul' %}#2563EB{% elif color == 'Verde' %}#16A34A{% elif color == 'Amarillo' %}#EAB308{% elif color == 'Gris' %}#6B7280{% elif color == 'Marr√≥n' %}#92400E{% elif color == 'Rosa' %}#EC4899{% elif color == 'Morado' %}#9333EA{% elif color == 'Beige' %}#D4A574{% elif color == 'Naranja' %}#EA580C{% else %}#C0A76B{% endif %}; {% if color == 'Negro' or color == 'Blanco' %}box-shadow: 0 0 0 1px rgba(192, 167, 107, 0.3);{% endif %}">
                        </div>
                        <span class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-xs text-gray-400 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity">
                            {{ color }}
                        </span>
                        <i class="checkmark fas fa-check absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white text-xl opacity-0 transition-opacity pointer-events-none" 
                           style="text-shadow: 0 0 4px rgba(0,0,0,0.8), 0 0 8px rgba(0,0,0,0.6);"></i>
                    </button>
                    {% endfor %}
                </div>
                <p class="text-xs text-gray-400 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>M√°ximo 3 colores por producto
                </p>
            </div>
            
            <!-- Tallas Disponibles (SEGUNDO) -->
            <div class="space-y-4">
                <h3 class="text-xl font-bold text-[#C0A76B] mb-4 flex items-center gap-2 border-b-2 border-[#C0A76B] pb-2">
                    <i class="fas fa-ruler text-2xl"></i>Tallas Disponibles
                </h3>
                <div class="flex flex-wrap gap-3" id="modal-tallas-container">
                    {% for talla in tallas_disponibles %}
                    <button class="modal-talla-btn px-5 py-3 border-2 border-[#C0A76B] rounded-lg hover:bg-[#C0A76B] hover:text-black transition-all font-bold text-white relative overflow-hidden" 
                            data-talla="{{ talla }}" onclick="seleccionarTalla('{{ talla }}')">
                        <span class="relative z-10">{{ talla }}</span>
                        <div class="absolute inset-0 bg-gradient-to-r from-[#C0A76B] to-yellow-500 transform -translate-x-full transition-transform duration-300"></div>
                    </button>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Info de Stock Detallado por Talla -->
            <div id="modal-stock-info" class="hidden bg-gradient-to-r from-green-900/20 to-blue-900/20 border-2 border-[#C0A76B] rounded-lg p-4 space-y-3">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-400 uppercase tracking-wide">Variante Seleccionada</p>
                        <p id="modal-stock-variante" class="text-lg font-bold text-white"></p>
                    </div>
                    <i class="fas fa-box text-3xl text-[#C0A76B] opacity-50"></i>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-black/30 rounded-lg p-3 border border-[#C0A76B]/30">
                        <p class="text-xs text-gray-400 uppercase">Stock Disponible</p>
                        <p id="modal-stock-cantidad" class="text-2xl font-bold text-green-400"></p>
                    </div>
                    <div class="bg-black/30 rounded-lg p-3 border border-[#C0A76B]/30">
                        <p class="text-xs text-gray-400 uppercase">ID Variante</p>
                        <p id="modal-variante-id" class="text-xl font-bold text-[#C0A76B]">#-</p>
                    </div>
                </div>
                
                <!-- Bot√≥n para gestionar inventario -->
                <a id="modal-btn-gestionar" href="#" class="hidden w-full text-center bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-500 hover:to-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all shadow-lg hover:shadow-blue-500/50 hover:scale-105">
                    <i class="fas fa-cog mr-2"></i>Gestionar Inventario
                </a>
            </div>
            
            <!-- Tabla de Stock por Tallas (cuando se selecciona un color) -->
            <div id="modal-stock-tabla" class="hidden bg-[#1a1a1a] border border-[#C0A76B] border-opacity-30 rounded-xl p-4">
                <h4 class="text-sm font-semibold text-[#C0A76B] mb-3 flex items-center gap-2">
                    <i class="fas fa-table"></i>Stock por Talla
                </h4>
                <div id="modal-tabla-contenido" class="space-y-2">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>
            
            <div id="modal-variante-seleccionada" class="hidden bg-[#1a1a1a] border border-[#C0A76B] rounded-lg p-3">
                <p class="text-sm text-gray-400">Variante seleccionada:</p>
                <p id="modal-variante-texto" class="text-white font-semibold"></p>
            </div>
            
            {% else %}
            <!-- Sin variantes - Mostrar stock disponible -->
            <div class="bg-gradient-to-r from-[#C0A76B]/10 to-yellow-900/10 border-2 border-[#C0A76B] rounded-xl p-4">
                <h3 class="text-lg font-semibold text-[#C0A76B] mb-3 flex items-center gap-2">
                    <i class="fas fa-box"></i>Disponibilidad
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-[#1a1a1a] border border-[#C0A76B] border-opacity-30 rounded-lg p-4">
                        <p class="text-xs text-gray-400 uppercase tracking-wide mb-2">Stock Disponible</p>
                        <p class="text-3xl font-bold {% if producto.stock > 10 %}text-green-400{% elif producto.stock > 0 %}text-yellow-400{% else %}text-red-400{% endif %}">
                            {{ producto.stock|default:0 }}
                        </p>
                        <p class="text-xs text-gray-400 mt-1">
                            {% if producto.stock > 10 %}
                                <i class="fas fa-check-circle text-green-400"></i> Disponible
                            {% elif producto.stock > 0 %}
                                <i class="fas fa-exclamation-triangle text-yellow-400"></i> Pocas unidades
                            {% else %}
                                <i class="fas fa-times-circle text-red-400"></i> Agotado
                            {% endif %}
                        </p>
                    </div>
                    <div class="bg-[#1a1a1a] border border-[#C0A76B] border-opacity-30 rounded-lg p-4">
                        <p class="text-xs text-gray-400 uppercase tracking-wide mb-2">Talla/Color</p>
                        <p class="text-lg font-bold text-white">Talla √∫nica</p>
                        <p class="text-xs text-gray-400 mt-1">
                            <i class="fas fa-info-circle"></i> Sin variantes
                        </p>
                    </div>
                </div>
                
                {% if user.is_staff %}
                <div class="mt-3 bg-blue-900/20 border border-blue-600 rounded-lg p-3">
                    <p class="text-xs text-blue-400">
                        <i class="fas fa-user-shield mr-1"></i>
                        <strong>Administrador:</strong> Puedes crear variantes en Dashboard ‚Üí Productos ‚Üí "Variantes"
                    </p>
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Formulario de Agregar al Carrito -->
            <div class="space-y-4">
                {% if variantes %}
                <!-- Con variantes: necesita selecci√≥n de talla y color -->
                <form id="modal-form-carrito" action="{% url 'agregar_al_carrito_variante' %}" method="POST" class="space-y-4">
                    {% csrf_token %}
                    <input type="hidden" name="variante_id" id="modal-variante-id-input" value="">
                    
                    <div class="space-y-2">
                        <label for="modal-cantidad" class="block text-[#C0A76B] font-semibold text-lg mb-2">
                            <i class="fas fa-sort-numeric-up mr-2"></i>Cantidad:
                        </label>
                        <input type="number" 
                               id="modal-cantidad" 
                               name="cantidad" 
                               value="1" 
                               min="1" 
                               max="100"
                               class="w-32 bg-[#0a0a0a] border-2 border-[#C0A76B] rounded-lg px-6 py-3 text-white text-center font-bold text-2xl focus:outline-none focus:ring-2 focus:ring-[#C0A76B] focus:border-yellow-500">
                    </div>
                    
                    <button type="submit" 
                            id="modal-btn-agregar"
                            disabled
                            class="w-full bg-gradient-to-r from-[#C0A76B] via-[#d4b876] to-[#C0A76B] text-black font-bold py-5 px-6 rounded-xl hover:from-[#d4b876] hover:via-[#e6c98a] hover:to-[#d4b876] transition-all duration-300 transform hover:scale-105 hover:shadow-[0_0_30px_rgba(192,167,107,0.6)] animate-pulse-slow disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:animate-none flex items-center justify-center gap-3 text-xl shadow-lg">
                        <i class="fas fa-shopping-cart text-2xl"></i>
                        <span>Agregar al Carrito</span>
                    </button>
                </form>
                
                {% else %}
                <!-- Sin variantes: agregar directamente el producto base -->
                <div class="bg-[#1a1a1a] border-2 border-[#C0A76B] rounded-xl p-6 space-y-5">
                    <h3 class="text-2xl font-bold text-[#C0A76B] mb-4 flex items-center gap-3 border-b-2 border-[#C0A76B] pb-3">
                        <i class="fas fa-shopping-bag text-2xl"></i>Agregar al Carrito
                    </h3>
                    
                    <form action="{% url 'agregar_al_carrito' producto.id %}" method="POST" class="space-y-5">
                        {% csrf_token %}
                        
                        <!-- Selector de Cantidad con controles m√°s grandes -->
                        <div class="space-y-2">
                            <label for="cantidad-base" class="block text-[#C0A76B] font-semibold text-lg mb-2">
                                <i class="fas fa-sort-numeric-up mr-2"></i>Cantidad de unidades:
                            </label>
                            <div class="flex items-center gap-4">
                                <button type="button" 
                                        onclick="cambiarCantidadBase(-1)"
                                        class="bg-[#C0A76B] hover:bg-[#d4b876] text-black font-bold w-12 h-12 rounded-lg transition-all hover:scale-110 disabled:opacity-50 disabled:cursor-not-allowed"
                                        {% if producto.stock == 0 %}disabled{% endif %}>
                                    <i class="fas fa-minus"></i>
                                </button>
                                
                                <input type="number" 
                                       id="cantidad-base" 
                                       name="cantidad" 
                                       value="1" 
                                       min="1" 
                                       max="{{ producto.stock }}"
                                       readonly
                                       class="w-32 bg-[#0a0a0a] border-2 border-[#C0A76B] rounded-lg px-6 py-3 text-white text-center font-bold text-2xl focus:outline-none focus:ring-2 focus:ring-[#C0A76B]">
                                
                                <button type="button" 
                                        onclick="cambiarCantidadBase(1)"
                                        class="bg-[#C0A76B] hover:bg-[#d4b876] text-black font-bold w-12 h-12 rounded-lg transition-all hover:scale-110 disabled:opacity-50 disabled:cursor-not-allowed"
                                        {% if producto.stock == 0 %}disabled{% endif %}>
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <p class="text-sm text-gray-400 mt-2">
                                <i class="fas fa-info-circle mr-1"></i>
                                Stock disponible: <span class="font-bold text-white">{{ producto.stock }}</span> unidades
                            </p>
                        </div>
                        
                        <!-- Bot√≥n de Agregar -->
                        <button type="submit" 
                                id="btn-agregar-sin-variantes"
                                class="w-full bg-gradient-to-r from-[#C0A76B] via-[#d4b876] to-[#C0A76B] text-black font-bold py-5 px-6 rounded-xl hover:from-[#d4b876] hover:via-[#e6c98a] hover:to-[#d4b876] transition-all duration-300 transform hover:scale-105 hover:shadow-[0_0_30px_rgba(192,167,107,0.6)] animate-pulse-slow flex items-center justify-center gap-3 text-xl shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:animate-none"
                                {% if producto.stock == 0 %}disabled{% endif %}>
                            {% if producto.stock > 0 %}
                                <i class="fas fa-shopping-cart text-2xl"></i>
                                <span>Agregar al Carrito</span>
                            {% else %}
                                <i class="fas fa-times-circle text-2xl"></i>
                                <span>Sin Stock Disponible</span>
                            {% endif %}
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
            
            <!-- Mensaje de Selecci√≥n -->
            <div id="modal-mensaje-seleccion" class="text-center py-3 px-4 bg-gray-800/50 rounded-lg border border-gray-700">
                <p class="text-sm text-gray-400">
                    {% if variantes %}
                        üëÜ Selecciona color y talla para ver stock disponible
                    {% else %}
                        ‚úì Producto sin variantes
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

{% if variantes %}
<script>
console.log('üöÄ Script de variantes cargado');

// Datos de variantes (solo una vez)
const modalVariantesData = [
    {% for v in variantes %}
    {
        id: {{ v.id }},
        talla: '{{ v.talla }}',
        color: '{{ v.color }}',
        stock: {{ v.stock }},
        imagen_url: '{% if v.imagen_url %}{{ v.imagen_url }}{% else %}{{ producto.imagen_url|default:"/static/imagenes/placeholder.png" }}{% endif %}',
        imagen_ia: {% if v.imagen_generada_ia %}true{% else %}false{% endif %}
    },
    {% endfor %}
];

console.log('üì¶ VARIANTES CARGADAS:', modalVariantesData.length, modalVariantesData);

// Variables globales
let modalTallaSeleccionada = null;
let modalColorSeleccionado = null;
let modalVarianteActual = null;

// Referencias a elementos del DOM
const modalImagen = document.getElementById('modal-producto-imagen');
const modalIaBadge = document.getElementById('modal-ia-badge');
const modalStockInfo = document.getElementById('modal-stock-info');
const modalStockCantidad = document.getElementById('modal-stock-cantidad');
const modalStockVariante = document.getElementById('modal-stock-variante');
const modalVarianteId = document.getElementById('modal-variante-id');
const modalMensaje = document.getElementById('modal-mensaje-seleccion');
const modalVarianteSeleccionada = document.getElementById('modal-variante-seleccionada');
const modalVarianteTexto = document.getElementById('modal-variante-texto');
const modalBtnGestionar = document.getElementById('modal-btn-gestionar');
const modalStockTabla = document.getElementById('modal-stock-tabla');
const modalTablaContenido = document.getElementById('modal-tabla-contenido');

// Funci√≥n para seleccionar color
window.seleccionarColor = function(color) {
    console.log('üé® Color seleccionado:', color);
    
    // Deseleccionar otros colores
    document.querySelectorAll('.modal-color-btn').forEach(btn => {
        btn.querySelector('div').classList.remove('border-[#C0A76B]', 'scale-110', 'shadow-lg', 'shadow-[#C0A76B]/50');
        btn.querySelector('.checkmark').style.opacity = '0';
    });
    
    // Seleccionar este color
    const btnSeleccionado = document.querySelector(`.modal-color-btn[data-color="${color}"]`);
    if (btnSeleccionado) {
        const circulo = btnSeleccionado.querySelector('div');
        const check = btnSeleccionado.querySelector('.checkmark');
        circulo.classList.add('border-[#C0A76B]', 'scale-110', 'shadow-lg', 'shadow-[#C0A76B]/50');
        check.style.opacity = '1';
    }
    
    modalColorSeleccionado = color;
    modalTallaSeleccionada = null;
    
    // Deseleccionar todas las tallas
    document.querySelectorAll('.modal-talla-btn').forEach(btn => {
        btn.classList.remove('bg-[#C0A76B]', 'text-black', 'scale-110', 'shadow-lg', 'shadow-[#C0A76B]/50');
        btn.classList.add('text-white');
        const div = btn.querySelector('div');
        if (div) div.style.transform = 'translateX(-100%)';
    });
    
    mostrarStockPorTallas();
    actualizarVarianteModal();
};

// Funci√≥n para seleccionar talla
window.seleccionarTalla = function(talla) {
    console.log('üëï Talla seleccionada:', talla);
    
    // Deseleccionar otras tallas
    document.querySelectorAll('.modal-talla-btn').forEach(btn => {
        btn.classList.remove('bg-[#C0A76B]', 'text-black', 'scale-110', 'shadow-lg', 'shadow-[#C0A76B]/50');
        btn.classList.add('text-white');
        const div = btn.querySelector('div');
        if (div) div.style.transform = 'translateX(-100%)';
    });
    
    // Seleccionar esta talla
    const btnSeleccionado = document.querySelector(`.modal-talla-btn[data-talla="${talla}"]`);
    if (btnSeleccionado) {
        btnSeleccionado.classList.add('bg-[#C0A76B]', 'text-black', 'scale-110', 'shadow-lg', 'shadow-[#C0A76B]/50');
        btnSeleccionado.classList.remove('text-white');
        const div = btnSeleccionado.querySelector('div');
        if (div) div.style.transform = 'translateX(0)';
    }
    
    modalTallaSeleccionada = talla;
    actualizarVarianteModal();
};

// Funci√≥n para mostrar stock por tallas
function mostrarStockPorTallas() {
    if (!modalColorSeleccionado) {
        modalStockTabla.classList.add('hidden');
        return;
    }
    
    // Filtrar variantes por el color seleccionado
    const variantesPorColor = modalVariantesData.filter(v => v.color === modalColorSeleccionado);
    
    if (variantesPorColor.length === 0) {
        modalStockTabla.classList.add('hidden');
        return;
    }
    
    // Mostrar tabla
    modalStockTabla.classList.remove('hidden');
    
    // Generar filas de la tabla
    let tablaHTML = '';
    variantesPorColor.forEach(v => {
        const stockClass = v.stock > 10 ? 'text-green-400' : v.stock > 0 ? 'text-yellow-400' : 'text-red-400';
        const stockIcon = v.stock > 10 ? 'fa-check-circle' : v.stock > 0 ? 'fa-exclamation-circle' : 'fa-times-circle';
        
        tablaHTML += `
            <div class="flex items-center justify-between p-3 bg-black/30 rounded-lg border border-[#C0A76B]/20 hover:border-[#C0A76B]/50 transition-all">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-[#C0A76B] rounded-lg flex items-center justify-center font-bold text-black">
                        ${v.talla}
                    </div>
                    <div>
                        <p class="text-sm text-white font-semibold">Talla ${v.talla}</p>
                        <p class="text-xs text-gray-400">ID: #${v.id}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-lg font-bold ${stockClass}">
                        <i class="fas ${stockIcon} mr-1"></i>${v.stock}
                    </p>
                    <p class="text-xs text-gray-400">unidades</p>
                </div>
            </div>
        `;
    });
    
    modalTablaContenido.innerHTML = tablaHTML;
}

function actualizarVarianteModal() {
    const variante = modalVariantesData.find(v => 
        v.talla === modalTallaSeleccionada && v.color === modalColorSeleccionado
    );
    
    if (variante && modalTallaSeleccionada && modalColorSeleccionado) {
        modalVarianteActual = variante;
        
        // Actualizar imagen
        if (variante.imagen_url) {
            modalImagen.src = variante.imagen_url;
        }
        
        // Mostrar/ocultar badge IA
        if (variante.imagen_ia) {
            modalIaBadge.classList.remove('hidden');
        } else {
            modalIaBadge.classList.add('hidden');
        }
        
        // Mostrar stock
        modalStockInfo.classList.remove('hidden');
        modalStockVariante.textContent = `${modalColorSeleccionado} - Talla ${modalTallaSeleccionada}`;
        modalStockCantidad.textContent = `${variante.stock} unidades`;
        modalVarianteId.textContent = `#${variante.id}`;
        
        // Color del stock
        if (variante.stock > 10) {
            modalStockCantidad.className = 'text-2xl font-bold text-green-400';
        } else if (variante.stock > 0) {
            modalStockCantidad.className = 'text-2xl font-bold text-yellow-400';
        } else {
            modalStockCantidad.className = 'text-2xl font-bold text-red-400';
        }
        
        // Mostrar bot√≥n de gestionar inventario
        modalBtnGestionar.classList.remove('hidden');
        modalBtnGestionar.classList.add('block');
        modalBtnGestionar.href = `/dashboard/variantes/ajustar/${variante.id}/`;
        
        // Mostrar variante seleccionada
        if (modalVarianteSeleccionada) {
            modalVarianteSeleccionada.classList.remove('hidden');
            modalVarianteTexto.textContent = `${modalColorSeleccionado} - Talla ${modalTallaSeleccionada}`;
        }
        
        // ACTUALIZAR BOT√ìN DE AGREGAR AL CARRITO
        const btnAgregar = document.getElementById('modal-btn-agregar');
        const varianteIdInput = document.getElementById('modal-variante-id-input');
        const cantidadInput = document.getElementById('modal-cantidad');
        
        if (btnAgregar && varianteIdInput) {
            // Actualizar el campo hidden con el ID de la variante
            varianteIdInput.value = variante.id;
            
            if (variante.stock > 0) {
                // Habilitar bot√≥n
                btnAgregar.disabled = false;
                btnAgregar.classList.remove('opacity-50', 'cursor-not-allowed');
                btnAgregar.innerHTML = `
                    <i class="fas fa-shopping-cart text-xl"></i>
                    <span class="text-lg">Agregar al Carrito</span>
                `;
                
                // Actualizar m√°ximo de cantidad
                if (cantidadInput) {
                    cantidadInput.max = variante.stock;
                    if (parseInt(cantidadInput.value) > variante.stock) {
                        cantidadInput.value = variante.stock;
                    }
                }
            } else {
                // Deshabilitar bot√≥n
                btnAgregar.disabled = true;
                btnAgregar.classList.add('opacity-50', 'cursor-not-allowed');
                btnAgregar.innerHTML = `
                    <i class="fas fa-times-circle text-xl"></i>
                    <span class="text-lg">Sin Stock</span>
                `;
            }
        }
        
        // Actualizar mensaje
        if (variante.stock > 0) {
            modalMensaje.innerHTML = `
                <p class="text-sm text-green-400 font-semibold">
                    <i class="fas fa-check-circle mr-1"></i>
                    ‚úì Disponible - Color: ${modalColorSeleccionado} | Talla: ${modalTallaSeleccionada} | Stock: ${variante.stock}
                </p>
            `;
            modalMensaje.className = 'text-center py-3 px-4 bg-green-900/20 rounded-lg border-2 border-green-600';
        } else {
            modalMensaje.innerHTML = `
                <p class="text-sm text-red-400 font-semibold">
                    <i class="fas fa-times-circle mr-1"></i>
                    ‚úó Sin stock en esta combinaci√≥n
                </p>
            `;
            modalMensaje.className = 'text-center py-3 px-4 bg-red-900/20 rounded-lg border-2 border-red-600';
        }
    } else if (modalColorSeleccionado) {
        // Solo color seleccionado, mostrar tabla
        modalStockInfo.classList.add('hidden');
        modalBtnGestionar.classList.add('hidden');
        modalBtnGestionar.classList.remove('block');
        if (modalVarianteSeleccionada) modalVarianteSeleccionada.classList.add('hidden');
        
        modalMensaje.innerHTML = `
            <p class="text-sm text-blue-400 font-semibold">
                <i class="fas fa-hand-pointer mr-1"></i>
                Selecciona una talla para ver el stock disponible
            </p>
        `;
        modalMensaje.className = 'text-center py-3 px-4 bg-blue-900/20 rounded-lg border-2 border-blue-600';
    } else {
        modalStockInfo.classList.add('hidden');
        modalStockTabla.classList.add('hidden');
        modalBtnGestionar.classList.add('hidden');
        modalBtnGestionar.classList.remove('block');
        if (modalVarianteSeleccionada) modalVarianteSeleccionada.classList.add('hidden');
    }
}

// Manejar el env√≠o del formulario con AJAX
const modalFormCarrito = document.getElementById('modal-form-carrito');
if (modalFormCarrito) {
    modalFormCarrito.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const btnAgregar = document.getElementById('modal-btn-agregar');
        
        // Deshabilitar bot√≥n temporalmente
        const btnTextoOriginal = btnAgregar.innerHTML;
        btnAgregar.disabled = true;
        btnAgregar.innerHTML = '<i class="fas fa-spinner fa-spin text-xl"></i><span class="text-lg">Agregando...</span>';
        
        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostrar notificaci√≥n de √©xito
                mostrarNotificacion(data.message || 'Producto agregado al carrito ‚úì', 'success');
                
                // Cerrar modal despu√©s de 1 segundo
                setTimeout(() => {
                    cerrarProductoModal();
                }, 1000);
                
                // Actualizar contador del carrito si existe
                const carritoContador = document.querySelector('.carrito-contador');
                if (carritoContador && data.carrito_total) {
                    carritoContador.textContent = data.carrito_total;
                }
            } else {
                // Mostrar error
                mostrarNotificacion(data.error || 'Error al agregar al carrito', 'error');
                btnAgregar.disabled = false;
                btnAgregar.innerHTML = btnTextoOriginal;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarNotificacion('Error al agregar al carrito', 'error');
            btnAgregar.disabled = false;
            btnAgregar.innerHTML = btnTextoOriginal;
        });
    });
}

console.log('‚úÖ Variantes del modal inicializadas correctamente');
</script>
{% else %}
<!-- Script para productos SIN variantes -->
<script>
console.log('üõçÔ∏è Producto sin variantes - Inicializando controles');

// Funci√≥n para cambiar cantidad en productos sin variantes
window.cambiarCantidadBase = function(cambio) {
    const input = document.getElementById('cantidad-base');
    if (!input) return;
    
    const valorActual = parseInt(input.value) || 1;
    const max = parseInt(input.max) || 100;
    const min = parseInt(input.min) || 1;
    
    let nuevoValor = valorActual + cambio;
    
    // Validar l√≠mites
    if (nuevoValor < min) nuevoValor = min;
    if (nuevoValor > max) {
        nuevoValor = max;
        mostrarNotificacion(`Stock m√°ximo disponible: ${max} unidades`, 'info');
    }
    
    input.value = nuevoValor;
    
    // Feedback visual
    input.style.transform = 'scale(1.1)';
    setTimeout(() => {
        input.style.transform = 'scale(1)';
    }, 200);
};

// Manejar env√≠o del formulario para productos sin variantes
const formSinVariantes = document.querySelector('form[action*="agregar_al_carrito"]');
const btnAgregarSinVariantes = document.getElementById('btn-agregar-sin-variantes');

if (formSinVariantes && btnAgregarSinVariantes) {
    formSinVariantes.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const btnTextoOriginal = btnAgregarSinVariantes.innerHTML;
        
        // Deshabilitar bot√≥n temporalmente
        btnAgregarSinVariantes.disabled = true;
        btnAgregarSinVariantes.innerHTML = '<i class="fas fa-spinner fa-spin text-2xl"></i><span>Agregando...</span>';
        
        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.ok) {
                // √âxito
                mostrarNotificacion('‚úì Producto agregado al carrito', 'success');
                
                // Cerrar modal despu√©s de 1 segundo
                setTimeout(() => {
                    cerrarProductoModal();
                }, 1000);
                
                // Actualizar contador del carrito si existe
                const carritoContador = document.querySelector('.carrito-contador');
                if (carritoContador) {
                    const itemsCount = parseInt(carritoContador.textContent || '0');
                    carritoContador.textContent = itemsCount + 1;
                }
            } else {
                // Error
                mostrarNotificacion(data.error || 'Error al agregar al carrito', 'error');
                btnAgregarSinVariantes.disabled = false;
                btnAgregarSinVariantes.innerHTML = btnTextoOriginal;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarNotificacion('Error al agregar al carrito', 'error');
            btnAgregarSinVariantes.disabled = false;
            btnAgregarSinVariantes.innerHTML = btnTextoOriginal;
        });
    });
}

console.log('‚úÖ Controles de producto sin variantes inicializados');
</script>
{% endif %}
