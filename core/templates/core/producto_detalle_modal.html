{% load static %}
<!-- MODAL DE DETALLE DE PRODUCTO -->
<button class="cerrar text-white hover:text-[#C0A76B] text-4xl font-bold cursor-pointer absolute top-4 right-6 z-20 transition-all hover:scale-110" 
        onclick="cerrarProductoModal()" 
        title="Cerrar">
    &times;
</button>

<div class="w-full max-h-[90vh] overflow-y-auto p-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Columna Izquierda - Imagen -->
        <div class="relative">
            <div class="sticky top-0">
                <img id="modal-producto-imagen" 
                     src="{{ producto.imagen_url|default:'/static/imagenes/placeholder.png' }}" 
                     alt="{{ producto.nombre }}" 
                     class="w-full rounded-xl border-4 border-[#C0A76B] shadow-2xl hover:scale-105 transition-transform duration-300">
            </div>
        </div>
        
        <!-- Columna Derecha - Información del producto -->
        <div class="text-white space-y-4">
            <!-- Nombre y Precio -->
            <div class="border-b border-[#C0A76B] pb-4">
                <h1 class="text-4xl font-bold text-[#C0A76B] mb-2">
                    {{ producto.nombre }}
                </h1>
                <div class="flex items-center justify-between">
                    <p class="text-3xl font-bold text-white">
                        ${{ producto.precio|floatformat:2 }}
                    </p>
                    <span class="text-sm text-gray-400 bg-black/30 px-3 py-1 rounded-full">
                        {{ producto.get_categoria_display }}
                    </span>
                </div>
            </div>
            
            <!-- Descripción -->
            <div class="bg-[#1a1a1a] border border-[#C0A76B] border-opacity-30 rounded-xl p-4">
                <h3 class="text-lg font-semibold text-[#C0A76B] mb-2">Descripción</h3>
                <p class="text-gray-300 text-sm leading-relaxed">
                    {{ producto.descripcion|default:"Sin descripción disponible" }}
                </p>
            </div>
            
            {% if variantes %}
            <!-- Colores Disponibles -->
            <div class="space-y-4">
                <h3 class="text-lg font-bold text-[#C0A76B] mb-2">Color</h3>
                <div class="flex flex-wrap gap-4" id="modal-colores-container">
                    {% for color in colores_disponibles|slice:":3" %}
                    <button class="modal-color-btn relative group" data-color="{{ color }}" onclick="seleccionarColor('{{ color }}')">
                        <div class="w-12 h-12 rounded-full border-2 border-transparent transition-all duration-300 hover:scale-110 hover:border-[#C0A76B] shadow-lg" 
                             style="background-color: {% if color == 'Negro' %}#000000{% elif color == 'Blanco' %}#FFFFFF{% elif color == 'Rojo' %}#DC2626{% elif color == 'Azul' %}#2563EB{% elif color == 'Verde' %}#16A34A{% else %}#C0A76B{% endif %};">
                        </div>
                        <span class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-xs text-gray-400 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity">
                            {{ color }}
                        </span>
                    </button>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Tallas Disponibles - Dinámicas según categoría -->
            <div class="space-y-4">
                <h3 class="text-lg font-bold text-[#C0A76B] mb-2">Talla</h3>
                
                {% if tallas_disponibles %}
                <!-- Usar tallas disponibles del backend -->
                <div class="flex flex-wrap gap-3" id="modal-tallas-container">
                    {% for talla in tallas_disponibles %}
                    <button class="modal-talla-btn px-4 py-2 border-2 border-[#C0A76B] rounded-lg hover:bg-[#C0A76B] hover:text-black transition-all font-bold text-white" 
                            data-talla="{{ talla }}" onclick="seleccionarTalla('{{ talla }}')">
                        {{ talla }}
                    </button>
                    {% endfor %}
                </div>
                
                {% else %}
                <!-- Tallas predeterminadas según categoría -->
                <div id="modal-tallas-container" class="flex flex-wrap gap-3">
                    <!-- Se llenará dinámicamente con JavaScript -->
                </div>
                
                <script>
                // Función para obtener tallas según categoría y género
                function obtenerTallasSegunCategoria() {
                    const categoria = "{{ producto.categoria|lower }}";
                    const esHombre = "{{ producto.nombre|lower }}".includes('hombre') || 
                                    "{{ producto.descripcion|lower }}".includes('hombre') ||
                                    "{{ producto.get_categoria_display|lower }}".includes('hombre');
                    const esMujer = "{{ producto.nombre|lower }}".includes('mujer') || 
                                   "{{ producto.descripcion|lower }}".includes('mujer') ||
                                   "{{ producto.get_categoria_display|lower }}".includes('mujer');
                    
                    let tallas = [];
                    
                    // Definir tallas según categoría
                    if (categoria.includes('zapatos') || categoria.includes('calzado')) {
                        if (esHombre) {
                            tallas = ['38', '39', '40', '41', '42', '43', '44', '45'];
                        } else if (esMujer) {
                            tallas = ['34', '35', '36', '37', '38', '39', '40', '41'];
                        } else {
                            // Unisex
                            tallas = ['35', '36', '37', '38', '39', '40', '41', '42', '43'];
                        }
                    } 
                    else if (categoria.includes('ropa')) {
                        if (esHombre) {
                            tallas = ['XS', 'S', 'M', 'L', 'XL', 'XXL', '3XL'];
                        } else if (esMujer) {
                            tallas = ['XS', 'S', 'M', 'L', 'XL', 'XXL', '3XL'];
                        } else {
                            // Unisex
                            tallas = ['XS', 'S', 'M', 'L', 'XL', 'XXL', '3XL'];
                        }
                    } 
                    else if (categoria.includes('camiseta') || categoria.includes('playera')) {
                        tallas = ['XS', 'S', 'M', 'L', 'XL'];
                    }
                    else if (categoria.includes('pantalon') || categoria.includes('jeans')) {
                        if (esHombre) {
                            tallas = ['28', '30', '32', '34', '36', '38', '40'];
                        } else if (esMujer) {
                            tallas = ['24', '26', '28', '30', '32', '34', '36'];
                        } else {
                            tallas = ['28', '30', '32', '34', '36'];
                        }
                    }
                    else {
                        // Tallas por defecto
                        tallas = ['Única', 'XS', 'S', 'M', 'L', 'XL'];
                    }
                    
                    return tallas;
                }
                
                // Cargar tallas cuando se abra el modal
                document.addEventListener('DOMContentLoaded', function() {
                    const tallas = obtenerTallasSegunCategoria();
                    const container = document.getElementById('modal-tallas-container');
                    
                    if (container) {
                        container.innerHTML = '';
                        tallas.forEach(talla => {
                            const btn = document.createElement('button');
                            btn.className = 'modal-talla-btn px-4 py-2 border-2 border-[#C0A76B] rounded-lg hover:bg-[#C0A76B] hover:text-black transition-all font-bold text-white';
                            btn.dataset.talla = talla;
                            btn.textContent = talla;
                            btn.onclick = function() { seleccionarTalla(talla); };
                            container.appendChild(btn);
                        });
                    }
                });
                </script>
                {% endif %}
                
                <!-- Indicador de tipo de talla -->
                <p class="text-xs text-gray-400 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    Tallas de 
                    {% if producto.categoria == 'zapatos' or producto.categoria == 'calzado' %}
                    calzado
                    {% elif producto.categoria == 'ropa' or producto.categoria == 'camisetas' or producto.categoria == 'pantalones' %}
                    ropa
                    {% else %}
                    producto
                    {% endif %}
                </p>
            </div>
            
            <!-- Información de Stock -->
            <div id="modal-stock-info" class="hidden bg-gradient-to-r from-green-900/20 to-blue-900/20 border-2 border-[#C0A76B] rounded-lg p-4 space-y-3">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-400 uppercase">Variante Seleccionada</p>
                        <p id="modal-stock-variante" class="text-lg font-bold text-white"></p>
                    </div>
                </div>
                
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-xs text-gray-400 uppercase">Stock Disponible</p>
                        <p id="modal-stock-cantidad" class="text-2xl font-bold text-green-400"></p>
                    </div>
                </div>
            </div>
            
            {% endif %}
            
            <!-- Formulario para Agregar al Carrito -->
            <div class="space-y-4 mt-6">
                {% if variantes %}
                <!-- Con variantes -->
                <div id="modal-mensaje-seleccion" class="bg-yellow-900/20 border border-yellow-600 rounded-lg p-3">
                    <p class="text-yellow-400 text-sm">
                        Selecciona talla y color para comprar
                    </p>
                </div>
                
                <form id="modal-form-carrito" action="{% url 'agregar_al_carrito_variante' %}" method="POST" class="space-y-4">
                    {% csrf_token %}
                    <input type="hidden" name="variante_id" id="modal-variante-id-input" value="">
                    
                    <div class="space-y-2">
                        <label for="modal-cantidad" class="block text-[#C0A76B] font-semibold">Cantidad:</label>
                        <div class="flex items-center gap-2">
                            <button type="button" onclick="cambiarCantidad(-1)" 
                                    class="bg-[#C0A76B] hover:bg-[#d4b876] text-black font-bold w-10 h-10 rounded-lg">
                                -
                            </button>
                            <input type="number" 
                                   id="modal-cantidad" 
                                   name="cantidad" 
                                   value="1" 
                                   min="1" 
                                   max="100"
                                   class="w-20 bg-[#0a0a0a] border-2 border-[#C0A76B] rounded-lg px-4 py-2 text-white text-center font-bold">
                            <button type="button" onclick="cambiarCantidad(1)" 
                                    class="bg-[#C0A76B] hover:bg-[#d4b876] text-black font-bold w-10 h-10 rounded-lg">
                                +
                            </button>
                        </div>
                    </div>
                    
                    <button type="submit" 
                            id="modal-btn-agregar"
                            disabled
                            class="w-full bg-[#C0A76B] hover:bg-[#d4b876] text-black font-bold py-3 px-4 rounded-lg transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                        <i class="fas fa-shopping-cart"></i>
                        <span id="btn-agregar-texto">Selecciona Talla y Color</span>
                    </button>
                </form>
                
                {% else %}
                <!-- Sin variantes -->
                <form action="{% url 'agregar_al_carrito' producto.id %}" method="POST" class="space-y-4">
                    {% csrf_token %}
                    
                    <div class="space-y-2">
                        <label for="cantidad-base" class="block text-[#C0A76B] font-semibold">Cantidad:</label>
                        <div class="flex items-center gap-2">
                            <button type="button" 
                                    onclick="cambiarCantidadBase(-1)"
                                    class="bg-[#C0A76B] hover:bg-[#d4b876] text-black font-bold w-10 h-10 rounded-lg"
                                    {% if producto.stock == 0 %}disabled{% endif %}>
                                -
                            </button>
                            
                            <input type="number" 
                                   id="cantidad-base" 
                                   name="cantidad" 
                                   value="1" 
                                   min="1" 
                                   max="{{ producto.stock }}"
                                   class="w-20 bg-[#0a0a0a] border-2 border-[#C0A76B] rounded-lg px-4 py-2 text-white text-center font-bold">
                            
                            <button type="button" 
                                    onclick="cambiarCantidadBase(1)"
                                    class="bg-[#C0A76B] hover:bg-[#d4b876] text-black font-bold w-10 h-10 rounded-lg"
                                    {% if producto.stock == 0 %}disabled{% endif %}>
                                +
                            </button>
                        </div>
                        <p class="text-sm text-gray-400">
                            Stock disponible: <span class="font-bold text-white">{{ producto.stock }}</span> unidades
                        </p>
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-[#C0A76B] hover:bg-[#d4b876] text-black font-bold py-3 px-4 rounded-lg transition-all duration-300 {% if producto.stock == 0 %}opacity-50 cursor-not-allowed{% endif %}"
                            {% if producto.stock == 0 %}disabled{% endif %}>
                        {% if producto.stock > 0 %}
                            <i class="fas fa-shopping-cart mr-2"></i>Agregar al Carrito
                        {% else %}
                            <i class="fas fa-times-circle mr-2"></i>Sin Stock
                        {% endif %}
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if variantes %}
<script>
// Datos de variantes
const modalVariantesData = [
    {% for v in variantes %}
    {
        id: {{ v.id }},
        talla: '{{ v.talla }}',
        color: '{{ v.color }}',
        stock: {{ v.stock }}
    },
    {% endfor %}
];

// Variables globales
let modalTallaSeleccionada = null;
let modalColorSeleccionado = null;

// Función para seleccionar color
window.seleccionarColor = function(color) {
    modalColorSeleccionado = color;
    modalTallaSeleccionada = null;
    
    // Actualizar UI
    document.querySelectorAll('.modal-color-btn').forEach(btn => {
        const div = btn.querySelector('div');
        if (btn.dataset.color === color) {
            div.classList.add('border-[#C0A76B]', 'scale-110');
        } else {
            div.classList.remove('border-[#C0A76B]', 'scale-110');
        }
    });
    
    document.querySelectorAll('.modal-talla-btn').forEach(btn => {
        btn.classList.remove('bg-[#C0A76B]', 'text-black');
        btn.classList.add('text-white');
    });
    
    actualizarVarianteModal();
};

// Función para seleccionar talla
window.seleccionarTalla = function(talla) {
    modalTallaSeleccionada = talla;
    
    // Actualizar UI
    document.querySelectorAll('.modal-talla-btn').forEach(btn => {
        if (btn.dataset.talla === talla) {
            btn.classList.add('bg-[#C0A76B]', 'text-black');
            btn.classList.remove('text-white');
        } else {
            btn.classList.remove('bg-[#C0A76B]', 'text-black');
            btn.classList.add('text-white');
        }
    });
    
    actualizarVarianteModal();
};

// Función para actualizar la variante seleccionada
function actualizarVarianteModal() {
    const variante = modalVariantesData.find(v => 
        v.talla === modalTallaSeleccionada && v.color === modalColorSeleccionado
    );
    
    const stockInfo = document.getElementById('modal-stock-info');
    const btnAgregar = document.getElementById('modal-btn-agregar');
    const varianteIdInput = document.getElementById('modal-variante-id-input');
    const cantidadInput = document.getElementById('modal-cantidad');
    const mensaje = document.getElementById('modal-mensaje-seleccion');
    
    if (variante && modalTallaSeleccionada && modalColorSeleccionado) {
        // Mostrar información de stock
        stockInfo.classList.remove('hidden');
        document.getElementById('modal-stock-variante').textContent = `${modalColorSeleccionado} - Talla ${modalTallaSeleccionada}`;
        
        const stockCantidad = document.getElementById('modal-stock-cantidad');
        stockCantidad.textContent = `${variante.stock} unidades`;
        stockCantidad.className = variante.stock > 0 ? 'text-2xl font-bold text-green-400' : 'text-2xl font-bold text-red-400';
        
        // Actualizar formulario
        varianteIdInput.value = variante.id;
        
        if (cantidadInput) {
            cantidadInput.max = variante.stock;
            if (parseInt(cantidadInput.value) > variante.stock) {
                cantidadInput.value = variante.stock;
            }
        }
        
        // Habilitar/deshabilitar botón
        if (variante.stock > 0) {
            btnAgregar.disabled = false;
            btnAgregar.classList.remove('opacity-50', 'cursor-not-allowed');
            document.getElementById('btn-agregar-texto').textContent = 'Agregar al Carrito';
            mensaje.innerHTML = `<p class="text-green-400 text-sm">✓ Disponible - Stock: ${variante.stock}</p>`;
        } else {
            btnAgregar.disabled = true;
            btnAgregar.classList.add('opacity-50', 'cursor-not-allowed');
            document.getElementById('btn-agregar-texto').textContent = 'Sin Stock';
            mensaje.innerHTML = `<p class="text-red-400 text-sm">✗ Sin stock disponible</p>`;
        }
    } else if (modalColorSeleccionado) {
        // Solo color seleccionado
        stockInfo.classList.add('hidden');
        btnAgregar.disabled = true;
        mensaje.innerHTML = `<p class="text-yellow-400 text-sm">Selecciona una talla</p>`;
    } else {
        // Nada seleccionado
        stockInfo.classList.add('hidden');
        btnAgregar.disabled = true;
        mensaje.innerHTML = `<p class="text-yellow-400 text-sm">Selecciona color y talla</p>`;
    }
}

// Función para cambiar cantidad
window.cambiarCantidad = function(cambio) {
    const input = document.getElementById('modal-cantidad');
    if (!input) return;
    
    const valorActual = parseInt(input.value) || 1;
    const max = parseInt(input.max) || 100;
    const min = parseInt(input.min) || 1;
    
    let nuevoValor = valorActual + cambio;
    
    if (nuevoValor < min) nuevoValor = min;
    if (nuevoValor > max) nuevoValor = max;
    
    input.value = nuevoValor;
};

// Manejar envío del formulario
const modalFormCarrito = document.getElementById('modal-form-carrito');
if (modalFormCarrito) {
    modalFormCarrito.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const btnAgregar = document.getElementById('modal-btn-agregar');
        
        // Deshabilitar botón temporalmente
        const btnTextoOriginal = btnAgregar.innerHTML;
        btnAgregar.disabled = true;
        btnAgregar.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Agregando...';
        
        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarNotificacion('Producto agregado al carrito ✓', 'success');
                setTimeout(() => {
                    cerrarProductoModal();
                }, 1000);
            } else {
                mostrarNotificacion(data.error || 'Error al agregar al carrito', 'error');
                btnAgregar.disabled = false;
                btnAgregar.innerHTML = btnTextoOriginal;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarNotificacion('Error al agregar al carrito', 'error');
            btnAgregar.disabled = false;
            btnAgregar.innerHTML = btnTextoOriginal;
        });
    });
}
</script>
{% else %}
<!-- Script para productos SIN variantes -->
<script>
// Función para cambiar cantidad
window.cambiarCantidadBase = function(cambio) {
    const input = document.getElementById('cantidad-base');
    if (!input) return;
    
    const valorActual = parseInt(input.value) || 1;
    const max = parseInt(input.max) || 100;
    const min = parseInt(input.min) || 1;
    
    let nuevoValor = valorActual + cambio;
    
    if (nuevoValor < min) nuevoValor = min;
    if (nuevoValor > max) nuevoValor = max;
    
    input.value = nuevoValor;
};

// Manejar envío del formulario
const formSinVariantes = document.querySelector('form[action*="agregar_al_carrito"]');
if (formSinVariantes) {
    formSinVariantes.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const btnAgregar = this.querySelector('button[type="submit"]');
        const btnTextoOriginal = btnAgregar.innerHTML;
        
        // Deshabilitar botón temporalmente
        btnAgregar.disabled = true;
        btnAgregar.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Agregando...';
        
        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.ok) {
                mostrarNotificacion('Producto agregado al carrito ✓', 'success');
                setTimeout(() => {
                    cerrarProductoModal();
                }, 1000);
            } else {
                mostrarNotificacion(data.error || 'Error al agregar al carrito', 'error');
                btnAgregar.disabled = false;
                btnAgregar.innerHTML = btnTextoOriginal;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarNotificacion('Error al agregar al carrito', 'error');
            btnAgregar.disabled = false;
            btnAgregar.innerHTML = btnTextoOriginal;
        });
    });
}
</script>
{% endif %}